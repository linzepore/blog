<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>23-03-04 | Linzepore's Blog</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Linzepore's Blog" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/Donate/"><span class="navItemTitle">Donate</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>23-03-04</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-03-04T01:50:52.000Z" id="date"> 2023-03-04</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-03-05T01:50:39.671Z" id="updated"> 2023-03-05</time></div></span></div></div><hr><div id="post-content"><h1 id="2023-03-04"><a href="#2023-03-04" class="headerlink" title="2023-03-04"></a>2023-03-04</h1><h2 id="call方法以及abi编解码"><a href="#call方法以及abi编解码" class="headerlink" title="call方法以及abi编解码"></a>call方法以及abi编解码</h2><h3 id="了解以下编码"><a href="#了解以下编码" class="headerlink" title="了解以下编码"></a>了解以下编码</h3><p>更多信息-&gt;<a target="_blank" rel="noopener" href="http://www.theblockbeats.info/tw/news/31815">查看文章</a></p>
<h4 id="abi-encodeCall"><a href="#abi-encodeCall" class="headerlink" title="abi.encodeCall"></a>abi.encodeCall</h4><p><code>bytes memory data = abi.encodeCall(MyContract.myFunction.selector, [arg1, arg2]);</code></p>
<p>abi.encodeCall是Solidity中的一个函数，它可以用来对函数调用进行编码。它接受一个函数选择器和一组参数，并返回一个字节数组，该字节数组可以用来调用指定的函数</p>
<p>优点：有类型检查（不是字符串形式）<br><img src="https://cdn.jsdelivr.net/gh/linzepore/blog_imgs@main/img/202303042102948.png"><br><img src="https://cdn.jsdelivr.net/gh/linzepore/blog_imgs@main/img/202303042101069.png"></p>
<h4 id="abi-encodePacked"><a href="#abi-encodePacked" class="headerlink" title="abi.encodePacked"></a>abi.encodePacked</h4><p>将给定参数根据其所需最低空间编码。它类似 abi.encode，<strong>但是会把其中填充的很多 0 省略</strong>。</p>
<p>比如，只用 1 字节来编码 uint 类型。当你想省空间，并且不与合约交互的时候，可以使用 abi.encodePacked，<strong>例如算一些数据的 hash（可作数据比较） 时</strong>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/linzepore/blog_imgs@main/img/202303041700806.png"></p>
<h4 id="abi-encodeWithSignature"><a href="#abi-encodeWithSignature" class="headerlink" title="abi.encodeWithSignature"></a>abi.encodeWithSignature</h4><p>与 abi.encode 功能类似，只不过<strong>第一个参数为函数签名</strong>，比如”foo(uint256,address)”。<strong>当调用其他合约的时候可以使用</strong>。<br>函数签名：bytes4(keccak(“函数名(函数类型)”))</p>
<p><img src="https://cdn.jsdelivr.net/gh/linzepore/blog_imgs@main/img/202303041659983.png"></p>
<h4 id="abi-endeWithSelector"><a href="#abi-endeWithSelector" class="headerlink" title="abi.endeWithSelector"></a>abi.endeWithSelector</h4><h5 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a>Selector</h5><p>相关文章-&gt;<a target="_blank" rel="noopener" href="https://www.tiege.dev/post/evm-selector/">HERE</a> </p>
<p>selector 可以通过两种方式获取，一种是查询 <code>function.selector</code>，另一种就是自己计算（如下）</p>
<p><code>return bytes4(keccak256(&quot;函数名(参数类型)&quot;)</code> &#x3D;&#x3D; <code>return 合约名(address).函数名.selector</code></p>
<p>与 abi.encodeWithSignature 功能类似，只不过<strong>第一个参数为函数选择器</strong>，为<strong>函数签名 Keccak 哈希的前 4 个字节</strong>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/linzepore/blog_imgs@main/img/202303041659027.png"></p>
<h4 id="abi-decode"><a href="#abi-decode" class="headerlink" title="abi.decode"></a>abi.decode</h4><p>abi.decode 用于解码 abi.encode 生成的二进制编码，将它还原成原本的参数。</p>
<p><code>(bool b, uint ui, string memory) = abi.decode(data,(bool, uint, string));</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/linzepore/blog_imgs@main/img/202303042007643.png"></p>
<h3 id="写法"><a href="#写法" class="headerlink" title="写法"></a>写法</h3><ul>
<li><p><code>address.call&#123;value:xxx, gas:xxx&#125;([bytes])</code> &#x3D;&#x3D; <code>address.call.value(xxx).gas(xxx)([bytes])</code>【右侧用法已被弃用】<br><img src="https://cdn.jsdelivr.net/gh/linzepore/blog_imgs@main/img/202303042022794.png"></p>
</li>
<li><p><code>address.call&#123;value:xxx, gas:xxx&#125;(abi.encodeWithSignature(&quot;函数名称(参数类型)&quot;), 参数)</code> &#x3D;&#x3D; <code>address.call&#123;value:xxx,gas:xxx&#125;(abi.encodeWithSelector(bytes4(keccak256(&quot;参数类型&quot;))),参数)</code></p>
</li>
</ul>
<h3 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h3><p><code>(bool success, bytes data)</code></p>
<p>call函数的返回结果是一个bool与bytes的元组，表示是否成功调用或者失败引起了EVM异常。该方法无法直接访问函数返回结果（因为需要事先知道编码和返回结果大小）</p>
<p><code>call()</code>的返回结果即使成功，并不能说操作成功了，只是没有出现异常，有可能调用到了<code>fallback()</code>函数</p>
<h3 id="调用另一个合约的方法"><a href="#调用另一个合约的方法" class="headerlink" title="调用另一个合约的方法"></a>调用另一个合约的方法</h3><ul>
<li>带参情况</li>
</ul>
<p><code>(bool success, bytes memory data) = _addr.call&#123;value: msg.value, gas: 5000&#125;(abi.encodeWithSignature(&quot;foo(string,uint256)&quot;, &quot;call foo&quot;, 123)) );</code> 花括号指定发送以太币数量以及可用gas数量，根据地址<code>_to</code>对应合约寻找函数foo(string,uint256)，后面跟着两个参数</p>
<ul>
<li>无参情况</li>
</ul>
<p><code>(bool success, bytes memory data) = _addr.call&#123;value: msg.value&#125;(abi.encodeWithSignature(&quot;doesNotExist()&quot;));</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//SPDX-License-Identifier: UNLICENSED</span><br><span class="line">pragma solidity ^0.8.17;</span><br><span class="line">contract Receiver &#123;</span><br><span class="line">    event received(string _callMsg, address _addr);</span><br><span class="line">    function foo(string memory funcName, uint num) payable external returns(uint)&#123;</span><br><span class="line">        emit received(funcName, msg.sender);</span><br><span class="line">        return num + 1;</span><br><span class="line">    &#125;</span><br><span class="line">    fallback() external&#123;</span><br><span class="line">        emit received(&quot;fail&quot;, msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">contract TestCall &#123;</span><br><span class="line">    function testCallFoo(address payable addr_to_be_called) payable public returns(bytes memory) &#123;</span><br><span class="line">        (bool ok, bytes memory data) = addr_to_be_called.call&#123;value:msg.value, gas:5000&#125;(abi.encodeWithSignature(&quot;foo(string, uint)&quot;, &quot;testCallFoo&quot;, 10));</span><br><span class="line">        require(ok, &quot;failed&quot;);</span><br><span class="line">        return data;</span><br><span class="line">    &#125;</span><br><span class="line">    function testDonotExist(address payable addr_to_be_called) payable public returns(bytes memory) &#123;</span><br><span class="line">        (bool ok, bytes memory data) = addr_to_be_called.call&#123;value:msg.value, gas:5000&#125;(abi.encodeWithSignature(&quot;DonotExist()&quot;));</span><br><span class="line">        require(ok, &quot;failed&quot;);</span><br><span class="line">        return data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/linzepore/blog_imgs@main/img/202303042015093.png"></p>
<h2 id="委托调用：Delegatecall"><a href="#委托调用：Delegatecall" class="headerlink" title="委托调用：Delegatecall"></a>委托调用：Delegatecall</h2><h3 id="写法-1"><a href="#写法-1" class="headerlink" title="写法"></a>写法</h3><p><code>address.delegatecall(abi.encodeCall(A.funA,(arg1, arg2, ...)))</code></p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p><img src="https://cdn.jsdelivr.net/gh/linzepore/blog_imgs@main/img/202303042108137.png"></p>
<h2 id="正常的调用其他合约"><a href="#正常的调用其他合约" class="headerlink" title="正常的调用其他合约"></a>正常的调用其他合约</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">//SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.17;</span><br><span class="line">contract Callee &#123;</span><br><span class="line">    uint public x;</span><br><span class="line">    uint public value;</span><br><span class="line">    function setX(uint _x) public returns(uint)&#123;</span><br><span class="line">        x = _x;</span><br><span class="line">        return x;</span><br><span class="line">    &#125;</span><br><span class="line">    function setXandEther(uint _x) public payable returns(uint, uint) &#123;</span><br><span class="line">        x = _x;</span><br><span class="line">        value = msg.value;</span><br><span class="line">        return (x, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">contract Caller &#123;</span><br><span class="line">    function setX(Callee cl, uint _x) public returns(uint x) &#123;</span><br><span class="line">        x= cl.setX(_x);</span><br><span class="line">    &#125;</span><br><span class="line">    function setXWithAddress(address addr, uint _x) public returns(uint x) &#123;</span><br><span class="line">        Callee cl = Callee(addr);</span><br><span class="line">        x = cl.setX(_x);</span><br><span class="line">    &#125;</span><br><span class="line">    function setXAndEther(Callee cl, uint _x) public payable returns(uint x, uint value) &#123;</span><br><span class="line">        (x, value) = cl.setXandEther&#123;value:msg.value&#125;(_x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>特别是<code>cl.setXandEther&#123;value:msg.value&#125;(_x);</code>里面的<code>&#123;value:msg.value&#125;</code>不要忘记</strong></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/03/05/2023-03-05.html/">← Next 23-03-05</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/03/02/%E6%8A%80%E6%9C%AF%E9%83%A8%E6%8E%88%E8%AF%BE.html/">校易班技术部第一次授课 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Linzepore</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2023-03-04"><span class="toc-number">1.</span> <span class="toc-text">2023-03-04</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#call%E6%96%B9%E6%B3%95%E4%BB%A5%E5%8F%8Aabi%E7%BC%96%E8%A7%A3%E7%A0%81"><span class="toc-number">1.1.</span> <span class="toc-text">call方法以及abi编解码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%86%E8%A7%A3%E4%BB%A5%E4%B8%8B%E7%BC%96%E7%A0%81"><span class="toc-number">1.1.1.</span> <span class="toc-text">了解以下编码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#abi-encodeCall"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">abi.encodeCall</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#abi-encodePacked"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">abi.encodePacked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#abi-encodeWithSignature"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">abi.encodeWithSignature</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#abi-endeWithSelector"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">abi.endeWithSelector</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Selector"><span class="toc-number">1.1.1.4.1.</span> <span class="toc-text">Selector</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#abi-decode"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">abi.decode</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E6%B3%95"><span class="toc-number">1.1.2.</span> <span class="toc-text">写法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">1.1.3.</span> <span class="toc-text">返回值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%90%88%E7%BA%A6%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.4.</span> <span class="toc-text">调用另一个合约的方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A7%94%E6%89%98%E8%B0%83%E7%94%A8%EF%BC%9ADelegatecall"><span class="toc-number">1.2.</span> <span class="toc-text">委托调用：Delegatecall</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E6%B3%95-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">写法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">1.2.2.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E7%9A%84%E8%B0%83%E7%94%A8%E5%85%B6%E4%BB%96%E5%90%88%E7%BA%A6"><span class="toc-number">1.3.</span> <span class="toc-text">正常的调用其他合约</span></a></li></ol></li></ol></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">粤ICP备19120384号-2</a></nobr><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{code.findCode();}</script><script src="/js/arknights.js"></script><script src="/js/pjax.js"></script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>